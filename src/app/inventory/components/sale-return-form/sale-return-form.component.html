<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">Sale Return</h2>
      <p class="text-muted mb-0">Process return for a sale transaction</p>
    </div>
    <button type="button" class="btn btn-outline-secondary" routerLink="/inventory/returns">
      <i class="fas fa-arrow-left me-2"></i>Back to Returns
    </button>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Sales Return Form</h4>
        <small>All fields marked with * are required</small>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="returnForm" (ngSubmit)="onSubmit()">
        
        <!-- Sale Search Section -->
        <div class="row mb-4">
          <div class="col-md-8">
            <label for="saleSearch" class="form-label fw-bold">Search Sale by ID *</label>
            <div class="input-group">
              <input 
                type="text" 
                class="form-control" 
                [formControl]="saleIdControl"
                placeholder="Enter sale ID (e.g., SALE_01K0XMERM392WTSN2XS49VPDP9)"
                id="saleSearch" />
              <button 
                class="btn btn-outline-secondary" 
                type="button"
                [disabled]="isSearching">
                <i class="fas fa-search" *ngIf="!isSearching"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isSearching"></i>
              </button>
            </div>
            <small class="text-muted">Search by complete sale ID or use the general search below</small>
          </div>
          <div class="col-md-4">
            <label for="returnDate" class="form-label fw-bold">Return Date *</label>
            <input 
              type="date" 
              class="form-control" 
              id="returnDate" 
              formControlName="returnDate" 
              required />
          </div>
        </div>
        
        <!-- Alternative Search -->
        <div class="row mb-4">
          <div class="col-md-12">
            <label for="generalSearch" class="form-label fw-bold">Or Search by Patient/Customer Name</label>
            <div class="input-group">
              <input 
                type="text" 
                class="form-control" 
                [formControl]="searchControl"
                placeholder="Search by patient name, phone, or sale details"
                id="generalSearch" />
              <button 
                class="btn btn-outline-secondary" 
                type="button"
                [disabled]="isSearching">
                <i class="fas fa-search" *ngIf="!isSearching"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isSearching"></i>
              </button>
            </div>
            <!-- Search Results -->
            <div class="position-relative" *ngIf="filteredSales.length > 0">
              <ul class="list-group position-absolute w-100" style="z-index: 1000;">
                <li 
                  *ngFor="let sale of filteredSales.slice(0, 5)" 
                  class="list-group-item list-group-item-action"
                  (click)="selectSale(sale)">
                  <div class="d-flex justify-content-between">
                    <span><strong>{{ returnsService.formatSaleId(sale.saleId || sale.id || '') }}</strong></span>
                    <span class="badge bg-primary">{{ sale.saleType }}</span>
                  </div>
                  <small class="text-muted d-block">{{ sale.patientName || sale.walkInCustomerName || 'Unknown Customer' }}</small>
                  <small class="text-success">₹{{ sale.grandTotal | number:'1.2-2' }} - {{ getSafeDate(sale.date || sale.saleDate) | date:'dd/MM/yyyy' }}</small>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Sale Details (shown when sale is selected) -->
        
        
        <!-- Sale Information -->
        <div class="row mb-4" *ngIf="selectedSale">
          <!-- Sale Information Card - Left Side -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-primary bg-gradient text-white">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Sale Information</h5>
              </div>
              <div class="card-body">
                <!-- First row: Sale ID, Date, Type, Patient ID -->
                <div class="row mb-3">
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Sale ID</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.saleId || selectedSale?.id }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Sale Date</label>
                      <p class="mb-0 fw-bold text-dark">{{ formatSaleDate(selectedSale?.saleDate) }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Sale Type</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.saleType || 'N/A' }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Patient ID</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.patientId || 'N/A' }}</p>
                    </div>
                  </div>
                </div>
                
                <!-- Second row: GST Type, Grand Total, Taxable Amount, Tax Amount -->
                <div class="row mb-3">
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">GST Type</label>
                      <span [ngClass]="{
                        'badge bg-success': selectedSale?.gstType === 'INCLUSIVE',
                        'badge bg-warning text-dark': selectedSale?.gstType === 'EXCLUSIVE',
                        'badge bg-secondary': !selectedSale?.gstType || selectedSale?.gstType === 'NON_GST'
                      }" class="align-self-start">
                        {{ selectedSale?.gstType || 'NON_GST' }}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Grand Total</label>
                      <p class="mb-0 fw-bold text-success">₹{{ selectedSale?.grandTotal || 0 | number:'1.2-2' }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Taxable Amount</label>
                      <p class="mb-0 fw-bold text-dark">₹{{ selectedSale?.totalTaxableAmount || 0 | number:'1.2-2' }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Tax Amount</label>
                      <p class="mb-0 fw-bold text-dark">₹{{ selectedSale?.totalTaxAmount || 0 | number:'1.2-2' }}</p>
                    </div>
                  </div>
                </div>
                
                <!-- Third row: MRP Amount, Discount Amount, Customer, Doctor -->
                <div class="row mb-3">
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">MRP Amount</label>
                      <p class="mb-0 fw-bold text-dark">₹{{ selectedSale?.totalMrpAmount || 0 | number:'1.2-2' }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Discount Amount</label>
                      <p class="mb-0 fw-bold text-danger">₹{{ selectedSale?.totalDiscountAmount || 0 | number:'1.2-2' }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Customer</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.walkInCustomerName || 'Walk-in' }}</p>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Doctor</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.doctorName || 'No Doctor' }}</p>
                    </div>
                  </div>
                </div>
                
                <!-- Fourth row: Payment Mode, Transaction Ref -->
                <div class="row">
                  <div class="col-md-3">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Payment Mode</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.paymentMode || 'Not specified' }}</p>
                    </div>
                  </div>
                  <div class="col-md-9">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Transaction Reference</label>
                      <p class="mb-0 fw-bold text-dark">{{ selectedSale?.transactionReference || 'N/A' }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Return Details Card - Right Side -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-success bg-gradient text-white">
                <h5 class="mb-0"><i class="bi bi-arrow-return-left me-2"></i>Return Details</h5>
              </div>
              <div class="card-body">
                <!-- Return Reason -->
                <div class="row mb-3">
                  <div class="col-12">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Return Reason <span class="text-danger">*</span></label>
                      <textarea 
                        class="form-control" 
                        id="reason" 
                        formControlName="reason" 
                        rows="3" 
                        placeholder="Please specify the reason for return"
                        required></textarea>
                    </div>
                  </div>
                </div>
                
                <!-- Refund Mode and Reference -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Refund Mode <span class="text-danger">*</span></label>
                      <select class="form-control" id="refundMode" formControlName="refundMode" required>
                        <option value="CASH">Cash</option>
                        <option value="CARD">Card</option>
                        <option value="UPI">UPI</option>
                        <option value="BANK_TRANSFER">Bank Transfer</option>
                        <option value="CHEQUE">Cheque</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Refund Reference</label>
                      <input 
                        type="text" 
                        class="form-control" 
                        id="refundReference" 
                        formControlName="refundReference" 
                        placeholder="Transaction/Reference ID" />
                    </div>
                  </div>
                </div>
                
                <!-- Overall Discount and Additional Notes -->
                <div class="row">
                  <div class="col-md-4">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Overall Discount %</label>
                      <input 
                        type="number" 
                        class="form-control" 
                        id="overallDiscountPercentage" 
                        formControlName="overallDiscountPercentage" 
                        min="0" 
                        max="100" 
                        step="0.01" 
                        placeholder="0.00" 
                        (input)="calculateTotalReturnAmount()" />
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="d-flex flex-column">
                      <label class="text-muted small mb-1">Additional Notes</label>
                      <textarea 
                        class="form-control" 
                        id="notes" 
                        formControlName="notes" 
                        rows="2" 
                        placeholder="Any additional notes or comments about the return"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sale Items for Return -->
        <div class="mb-4" *ngIf="selectedSale">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Sale Items for Return</h5>
            <span class="badge bg-info">{{ itemsArray.length }} items available</span>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Medicine</th>
                  <th>Batch No</th>
                  <th>Expiry Date</th>
                  <th>Original Qty</th>
                  <th>Unit Price</th>
                  <th>Tax Profile</th>
                  <th>Return Qty</th>
                  <th>Return Value</th>
                </tr>
              </thead>
              <tbody formArrayName="items">
                <tr *ngFor="let item of itemsArray.controls; let i = index" [formGroupName]="i" class="align-middle">
                  <td>
                    <div class="fw-bold">{{ getFormGroup(item).get('medicineName')?.value }}</div>
                    <small class="text-muted">ID: {{ getFormGroup(item).get('medicineId')?.value?.substring(0, 8) }}...</small>
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ getFormGroup(item).get('batchNo')?.value }}</span>
                  </td>
                  <td>
                    <small>{{ getFormGroup(item).get('expiryDate')?.value | date:'dd/MM/yyyy' }}</small>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ getFormGroup(item).get('originalQuantity')?.value }}</span>
                  </td>
                  <td>
                    <span class="text-success fw-bold">₹{{ getFormGroup(item).get('unitPrice')?.value | number:'1.2-2' }}</span>
                  </td>
                  <td>
                    <small class="badge bg-info">{{ getFormGroup(item).get('taxProfileId')?.value }}</small>
                  </td>
                  <td>
                    <input 
                      type="number" 
                      class="form-control" 
                      formControlName="returnQuantity" 
                      min="0" 
                      [max]="getFormGroup(item).get('originalQuantity')?.value" 
                      step="1" 
                      placeholder="0" />
                  </td>
                  <td>
                    <span class="fw-bold text-danger">₹{{ getFormGroup(item).get('returnValue')?.value | number:'1.2-2' }}</span>
                  </td>
                </tr>
              </tbody>
              <tfoot class="table-light">
                <tr class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>Total Before Discount:</strong></td>
                  <td class="text-end"><strong>₹{{ returnForm.get('totalBeforeDiscount')?.value | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <tr class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>Total Discount:</strong></td>
                  <td class="text-end"><strong>₹{{ returnForm.get('totalDiscountAmount')?.value | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <tr class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>Taxable Amount:</strong></td>
                  <td class="text-end"><strong>₹{{ (returnForm.get('totalBeforeDiscount')?.value - returnForm.get('totalDiscountAmount')?.value) | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <!-- CGST/SGST for intra-state transactions -->
                <tr *ngIf="returnForm.get('gstType')?.value !== 'NON_GST' && returnForm.get('cgstTotal')?.value > 0" class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>CGST Amount:</strong></td>
                  <td class="text-end"><strong class="text-primary">₹{{ returnForm.get('cgstTotal')?.value | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <tr *ngIf="returnForm.get('gstType')?.value !== 'NON_GST' && returnForm.get('sgstTotal')?.value > 0" class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>SGST Amount:</strong></td>
                  <td class="text-end"><strong class="text-primary">₹{{ returnForm.get('sgstTotal')?.value | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <!-- IGST for inter-state transactions -->
                <tr *ngIf="returnForm.get('gstType')?.value !== 'NON_GST' && returnForm.get('igstTotal')?.value > 0" class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>IGST Amount:</strong></td>
                  <td class="text-end"><strong class="text-primary">₹{{ returnForm.get('igstTotal')?.value | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
                <tr class="bg-light">
                  <td colspan="5" class="text-end pe-4"><strong>Total Return Amount:</strong></td>
                  <td class="text-end"><strong class="text-success">₹{{ returnForm.get('totalReturnAmount')?.value | number:'1.2-2' }}</strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex justify-content-between align-items-center">
          <button type="button" class="btn btn-outline-secondary" routerLink="/inventory/returns">
            <i class="fas fa-arrow-left me-2"></i>Back to Returns
          </button>
          <div class="d-flex gap-2">
            <button 
              type="submit" 
              class="btn btn-success btn-lg" 
              [disabled]="isLoading || itemsArray.length === 0">
              <i class="fas fa-spinner fa-spin me-2" *ngIf="isLoading"></i>
              <i class="fas fa-check-circle me-2" *ngIf="!isLoading"></i>
              {{ isLoading ? 'Processing Return...' : 'Create Sale Return' }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Return Summary Card -->
  <div class="card border-success" *ngIf="selectedSale && returnForm.get('totalReturnAmount')?.value > 0">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">Return Summary</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-2">
          <div class="text-center">
            <h6 class="text-muted">Total Return Amount</h6>
            <h4 class="text-success">₹{{ returnForm.get('totalReturnAmount')?.value | number:'1.2-2' }}</h4>
          </div>
        </div>
        <div class="col-md-2">
          <div class="text-center">
            <h6 class="text-muted">Discount Amount</h6>
            <h4 class="text-danger">₹{{ returnForm.get('totalDiscountAmount')?.value | number:'1.2-2' }}</h4>
          </div>
        </div>
        <div class="col-md-2">
          <div class="text-center">
            <h6 class="text-muted">Items to Return</h6>
            <h4 class="text-info">{{ getItemsToReturnCount() }}</h4>
          </div>
        </div>
        <div class="col-md-2" *ngIf="returnForm.get('gstType')?.value !== 'NON_GST'">
          <div class="text-center">
            <h6 class="text-muted">CGST</h6>
            <h4 class="text-info">₹{{ returnForm.get('cgstTotal')?.value | number:'1.2-2' }}</h4>
          </div>
        </div>
        <div class="col-md-2" *ngIf="returnForm.get('gstType')?.value !== 'NON_GST'">
          <div class="text-center">
            <h6 class="text-muted">SGST</h6>
            <h4 class="text-info">₹{{ returnForm.get('sgstTotal')?.value | number:'1.2-2' }}</h4>
          </div>
        </div>
        <div class="col-md-2">
          <div class="text-center">
            <h6 class="text-muted">Refund Mode</h6>
            <h4 class="text-warning">{{ returnForm.get('refundMode')?.value }}</h4>
          </div>
        </div>
        <div class="col-md-2">
          <div class="text-center">
            <h6 class="text-muted">Net Refund Amount</h6>
            <h4 class="text-primary">₹{{ returnForm.get('netRefundAmount')?.value | number:'1.2-2' }}</h4>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
