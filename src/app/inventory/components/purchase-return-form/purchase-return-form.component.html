<div class="container-fluid py-4">
  <!-- Back button and page title -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button type="button" class="btn btn-outline-primary" routerLink="/inventory/returns">
      <i class="fas fa-arrow-left me-2"></i>Back to Returns
    </button>
    <h3 class="mb-0">Create Purchase Return</h3>
    <div></div> <!-- Empty div for flex spacing -->
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Purchase Return Form</h4>
        <small>All fields marked with * are required</small>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="returnForm" (ngSubmit)="onSubmit()">
        <div class="row mb-4">
          <div class="col-md-6">
            <!-- Purchase Selection -->
            <div class="form-group mb-3">
              <label for="purchaseSearch" class="form-label">Search Purchase</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  id="purchaseSearch" 
                  [value]="purchaseSearchText"
                  (input)="searchPurchases($event)" 
                  placeholder="Search by purchase ID or supplier" />
                <button 
                  class="btn btn-outline-secondary" 
                  type="button"
                  [disabled]="isSearching">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <!-- Purchase Search Results -->
              <div class="position-relative">
                <ul class="list-group position-absolute w-100" style="z-index: 1000;" 
                    *ngIf="filteredPurchases.length > 0">
                  <li 
                    *ngFor="let purchase of filteredPurchases" 
                    class="list-group-item list-group-item-action"
                    (click)="selectPurchase(purchase)">
                    <div class="d-flex justify-content-between">
                      <span>{{ returnsService.formatPurchaseId(purchase.id || purchase.purchaseId || '') }}</span>
                      <span>{{ purchase.referenceId || '' }}</span>
                      <span>{{ purchase.supplier?.name || 'Supplier ID: ' + (purchase.supplierId || '').substring(4, 12) }}</span>
                      <span>{{ purchase.totalAmount | currency:'INR' }}</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Return Date -->
            <div class="form-group mb-3">
              <label for="returnDate" class="form-label">Return Date</label>
              <input 
                type="datetime-local" 
                id="returnDate" 
                formControlName="returnDate"
                class="form-control" 
                [class.is-invalid]="returnForm.get('returnDate')?.invalid && returnForm.get('returnDate')?.touched" />
              <div class="invalid-feedback" 
                   *ngIf="returnForm.get('returnDate')?.invalid && returnForm.get('returnDate')?.touched">
                Return date is required
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <!-- Supplier -->
            <div class="form-group mb-3">
              <label for="supplierName" class="form-label">Supplier</label>
              <input 
                type="text" 
                id="supplierName" 
                formControlName="supplierName"
                class="form-control" 
                readonly />
            </div>
            
            <!-- Reason -->
            <div class="form-group mb-3">
              <label for="reason" class="form-label">Reason for Return</label>
              <textarea 
                id="reason" 
                formControlName="reason"
                class="form-control" 
                rows="3"
                [class.is-invalid]="returnForm.get('reason')?.invalid && returnForm.get('reason')?.touched"></textarea>
              <div class="invalid-feedback" 
                   *ngIf="returnForm.get('reason')?.invalid && returnForm.get('reason')?.touched">
                Reason is required
              </div>
            </div>
          </div>
        </div>

        <!-- Purchase Items -->
        <div class="mb-3" *ngIf="selectedPurchase">
          <h5>Purchase Items</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>Medicine</th>
                  <th>Batch No</th>
                  <th>Purchase Price</th>
                  <th>Original Qty</th>
                  <th>Return Qty</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of itemsArray.controls; let i = index" [formGroup]="getFormGroup(item)">
                  <td>{{ item.get('medicineName')?.value }}</td>
                  <td>
                    <input 
                      type="text" 
                      formControlName="batchNo"
                      class="form-control form-control-sm"
                      [class.is-invalid]="item.get('batchNo')?.invalid && item.get('batchNo')?.touched" />
                    <div class="invalid-feedback" *ngIf="item.get('batchNo')?.invalid && item.get('batchNo')?.touched">Batch number is required</div>
                  </td>
                  <td>{{ item.get('purchasePrice')?.value | currency:'INR' }}</td>
                  <td>{{ item.get('originalQuantity')?.value }}</td>
                  <td>
                    <input 
                      type="number" 
                      formControlName="returnQuantity"
                      class="form-control form-control-sm" 
                      min="0"
                      [max]="item.get('originalQuantity')?.value"
                      [class.is-invalid]="item.get('returnQuantity')?.invalid && item.get('returnQuantity')?.touched" />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-light d-flex justify-content-between mt-4">
          <button 
            type="button" 
            class="btn btn-outline-secondary"
            routerLink="/inventory/returns">
            <i class="fas fa-times me-2"></i>Cancel
          </button>
          <div>
            <button 
              type="button" 
              class="btn btn-outline-danger me-2"
              (click)="resetForm()">
              <i class="fas fa-redo me-2"></i>Reset Form
            </button>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="isSubmitting || returnForm.invalid">
              <i class="fas fa-save me-2" *ngIf="!isSubmitting"></i>
              <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
              Create Return
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
